rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is a support agent
    function isSupportAgent() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'support agent';
    }

    // Helper function to check if user is an admin
    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }

    // Rule for the 'shelters' collection
    match /shelters/{shelterId} {
      allow read: if true; 
      allow update: if request.auth != null && (
        isAdmin() || 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['rating', 'ratingCount'])
      );
      allow create, delete: if isAdmin();
    }

    // Rule for the 'users' collection
    match /users/{userId} {
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        isSupportAgent() ||
        isAdmin() ||
        resource.data.role == 'support agent'
      );

      allow list: if request.auth != null && (
        isSupportAgent() ||
        isAdmin() ||
        true
      );

      allow create: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow update: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow delete: if isAdmin();
    }

    // Rules for the 'sosAlerts' collection
    match /sosAlerts/{alertId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if isAdmin();
    }

    // Rules for the 'displacedPersons' collection
    match /displacedPersons/{personId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null;
      allow delete: if isAdmin();
    }

    // Rules for the 'drivers' collection
    match /drivers/{driverId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null;
      allow delete: if isAdmin();
    }

    // Rules for the 'ussdCodes' collection
    match /ussdCodes/{codeId} {
      allow read: if true;
      allow create, update: if request.auth != null;
      allow delete: if isAdmin();
    }

    // Rules for the 'vehicles' collection
    match /vehicles/{vehicleId} {
      allow read: if request.auth != null;
      allow create, update, delete: if isAdmin();
    }

    // Consolidated rules for the 'chats' collection
    match /chats/{chatId} {
      allow list: if request.auth != null;
      allow read, update, delete: if request.auth != null && (
        request.auth.uid in resource.data.participants ||
        isAdmin() ||
        (isSupportAgent() && resource.data.agentId == request.auth.uid) ||
        (isSupportAgent() && resource.data.status == 'active')
      );
      allow create: if request.auth != null;

      match /messages/{messageId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]) ||
          isAdmin() ||
          (isSupportAgent() && get(/databases/$(database)/documents/chats/$(chatId)).data.agentId == request.auth.uid) ||
          (isSupportAgent() && get(/databases/$(database)/documents/chats/$(chatId)).data.status == 'active')
        );

        allow create: if request.auth != null &&
          request.auth.uid == request.resource.data.senderId &&
          (isAdmin() || get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]));

        allow update: if request.auth != null && (
          request.auth.uid == resource.data.senderId ||
          isAdmin() ||
          (isSupportAgent() && get(/databases/$(database)/documents/chats/$(chatId)).data.agentId == request.auth.uid) ||
          get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid])
        );
      }
    }

    // Rules for the 'calls' collection (for voice calls)
    match /calls/{callId} {
      allow create: if request.auth != null;
      allow list: if isAdmin() || isSupportAgent() && (
        request.query.filters.size() >= 1 &&
        request.query.filters[0].field == 'status' &&
        request.query.filters[0].op == 'in' &&
        request.query.filters[0].value.hasAny(['ringing', 'active'])
      );

      allow read: if request.auth != null && (
        request.auth.uid == resource.data.get('userId', '') ||
        isAdmin() ||
        isSupportAgent()
      );

      allow update: if request.auth != null && (
        request.auth.uid == resource.data.get('userId', '') ||
        isAdmin() ||
        isSupportAgent()
      );
    }

    // Rules for the 'location_requests' collection
    match /location_requests/{requestId} {
      allow read, list, write: if isAdmin() || isSupportAgent();
    }

    // Rules for the 'emergency_locations' collection
    match /emergency_locations/{emergencyId} {
      allow read, list, write: if isAdmin() || isSupportAgent();
    }

    // Rules for the 'notifications' collection
    match /notifications/{notificationId} {
      allow read, list, write, delete: if isAdmin() || isSupportAgent();
    }
  }
}

